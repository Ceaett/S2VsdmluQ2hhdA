<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoramento de Localização em Tempo Real</title>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }

    #map {
      height: 60%;
      width: 100%;
    }

    .info-container {
      height: 40%;
      background-color: #f7f7f7;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
    }

    .info-item {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .info-item span {
      font-weight: bold;
    }

    .notification {
      color: green;
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
    }

    .auth-container {
      width: 100%;
      padding: 20px;
    }

    .auth-container input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      #map {
        height: 50%;
      }

      .info-container {
        height: 50%;
      }
    }
  </style>
  <script type="module">
    // Importar funções do Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-analytics.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-storage.js";

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5_a0YuNjHDI7NfMuo90e5N475WeThTFo",
      authDomain: "kmonitoramento-1e504.firebaseapp.com",
      databaseURL: "https://kmonitoramento-1e504-default-rtdb.firebaseio.com",
      projectId: "kmonitoramento-1e504",
      storageBucket: "kmonitoramento-1e504.firebasestorage.app",
      messagingSenderId: "1036253657697",
      appId: "1:1036253657697:web:6077a46bc9b58ae5ac0820",
      measurementId: "G-LNM4FPTNRH"
    };

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const auth = getAuth();
    const storage = getStorage(app);

    let map, marker, deviceInfoDiv, notificationDiv, user;
    let lastLatitude = null;
    let lastLongitude = null;

    // Função para iniciar o mapa com o Leaflet.js
    function initMap() {
      map = L.map('map').setView([-23.55052, -46.633308], 15);  // Posição inicial em São Paulo

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      marker = L.marker([0, 0]).addTo(map);
    }

    // Função para atualizar a localização no Firebase
    function updateLocation(latitude, longitude, batteryLevel, deviceName, userName, userSurname, userProfilePic) {
      const locationRef = ref(db, 'locations/device');
      set(locationRef, {
        latitude: latitude,
        longitude: longitude,
        batteryLevel: batteryLevel,
        deviceName: deviceName,
        userName: userName,
        userSurname: userSurname,
        userProfilePic: userProfilePic
      });

      // Salvar histórico de localizações
      const locationsHistoryRef = ref(db, 'locations/history');
      push(locationsHistoryRef, {
        latitude: latitude,
        longitude: longitude,
        timestamp: new Date().toISOString()
      });
    }

    // Função para rastrear a localização do dispositivo
    function trackLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(async (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;

          // Obtém o nível de bateria com a API do navegador
          const battery = await navigator.getBattery();
          const batteryLevel = Math.round(battery.level * 100); // Obtém o nível de bateria em %
          const deviceName = navigator.userAgent; // Nome do dispositivo (userAgent)

          // Atualiza a localização e informações do dispositivo no Firebase
          if (user) {
            updateLocation(latitude, longitude, batteryLevel, deviceName, user.displayName.split(" ")[0], user.displayName.split(" ")[1], user.photoURL);
          }

          // Exibe a localização no mapa
          marker.setLatLng([latitude, longitude]);
          map.setView([latitude, longitude], 15);
        }, (error) => {
          console.error('Erro ao obter a geolocalização', error);
        });
      } else {
        alert("Geolocalização não suportada pelo seu navegador.");
      }
    }

    // Função para login
    function loginUser(email, password) {
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          user = userCredential.user;
          alert("Login bem-sucedido!");
          document.getElementById('auth-container').style.display = 'none';
          initMap();
          trackLocation();
        })
        .catch((error) => {
          console.error(error);
          alert("Falha no login. Tente novamente.");
        });
    }

    // Função para cadastro
    function registerUser(name, surname, email, password, profilePic) {
      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          user = userCredential.user;

          // Salva o nome e sobrenome no displayName
          user.updateProfile({
            displayName: `${name} ${surname}`,
            photoURL: profilePic
          }).then(() => {
            alert("Cadastro bem-sucedido!");
            document.getElementById('auth-container').style.display = 'none';
            initMap();
            trackLocation();
          });
        })
        .catch((error) => {
          console.error(error);
          alert("Falha no cadastro. Tente novamente.");
        });
    }

    // Função para mostrar formulário de cadastro
    function showRegisterForm() {
      document.getElementById('auth-container').innerHTML = `
        <h2>Cadastro</h2>
        <input type="text" id="name" placeholder="Nome" required>
        <input type="text" id="surname" placeholder="Sobrenome" required>
        <input type="email" id="email" placeholder="E-mail" required>
        <input type="password" id="password" placeholder="Senha" required>
        <input type="file" id="profilePic" accept="image/*" required>
        <button onclick="registerUser(
          document.getElementById('name').value, 
          document.getElementById('surname').value, 
          document.getElementById('email').value, 
          document.getElementById('password').value, 
          URL.createObjectURL(document.getElementById('profilePic').files[0])
        )">Cadastrar</button>
      `;
    }

    // Função para mostrar formulário de login
    function showLoginForm() {
      document.getElementById('auth-container').innerHTML = `
        <h2>Login</h2>
        <input type="email" id="email" placeholder="E-mail" required>
        <input type="password" id="password" placeholder="Senha" required>
        <button onclick="loginUser(
          document.getElementById('email').value, 
          document.getElementById('password').value
        )">Login</button>
        <button onclick="showRegisterForm()">Não tem uma conta? Cadastre-se</button>
      `;
    }

    // Função para verificar o estado de autenticação
    onAuthStateChanged(auth, (userCredential) => {
      if (userCredential) {
        user = userCredential;
        document.getElementById('auth-container').style.display = 'none';
        initMap();
        trackLocation();
      } else {
        showLoginForm();
      }
    });

    window.onload = () => {
      deviceInfoDiv = document.getElementById('device-info');
      notificationDiv = document.getElementById('notification');
      document.getElementById('auth-container').style.display = 'block';
    };
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
  <div id="auth-container" class="auth-container"></div>
  <div id="map"></div>
  <div class="info-container" id="device-info">
    <div class="info-item"><span>Nome do Dispositivo:</span> Carregando...</div>
    <div class="info-item"><span>Nível de Bateria:</span> Carregando...</div>
    <div class="info-item"><span>Endereço:</span> Carregando...</div>
    <div class="info-item"><span>Cidade:</span> Carregando...</div>
    <div class="info-item"><span>Estado:</span> Carregando...</div>
    <div class="info-item"><span>País:</span> Carregando...</div>
  </div>
  <div class="notification" id="notification"></div>
</body>
</html>
