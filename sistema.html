<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoramento de Localização em Tempo Real</title>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }

    #map {
      height: 60%;
      width: 100%;
    }

    .info-container {
      height: 40%;
      background-color: #f7f7f7;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
    }

    .info-item {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .info-item span {
      font-weight: bold;
    }

    .notification {
      color: green;
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      #map {
        height: 50%;
      }

      .info-container {
        height: 50%;
      }
    }
  </style>
  <script type="module">
    // Importar funções do Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-analytics.js";

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5_a0YuNjHDI7NfMuo90e5N475WeThTFo",
      authDomain: "kmonitoramento-1e504.firebaseapp.com",
      databaseURL: "https://kmonitoramento-1e504-default-rtdb.firebaseio.com",
      projectId: "kmonitoramento-1e504",
      storageBucket: "kmonitoramento-1e504.firebasestorage.app",
      messagingSenderId: "1036253657697",
      appId: "1:1036253657697:web:6077a46bc9b58ae5ac0820",
      measurementId: "G-LNM4FPTNRH"
    };

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    let map, marker, deviceInfoDiv, notificationDiv;
    let lastLatitude = null;
    let lastLongitude = null;

    // Função para iniciar o mapa com o Leaflet.js
    function initMap() {
      map = L.map('map').setView([-23.55052, -46.633308], 15);  // Posição inicial em São Paulo

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      marker = L.marker([0, 0]).addTo(map);
    }

    // Função para atualizar a localização no Firebase
    function updateLocation(latitude, longitude, batteryLevel, deviceName) {
      const locationRef = ref(db, 'locations/device');
      set(locationRef, {
        latitude: latitude,
        longitude: longitude,
        batteryLevel: batteryLevel,
        deviceName: deviceName
      });

      // Salvar histórico de localizações
      const locationsHistoryRef = ref(db, 'locations/history');
      push(locationsHistoryRef, {
        latitude: latitude,
        longitude: longitude,
        timestamp: new Date().toISOString()
      });
    }

    // Função para obter o endereço com OpenCage Geocoder
    async function getAddressFromCoordinates(latitude, longitude) {
      const apiKey = 'd27b45b0909941a38a2f716f5b090698'; // Sua chave de API do OpenCage
      const url = `https://api.opencagedata.com/geocode/v1/json?q=${latitude}+${longitude}&key=${apiKey}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.results && data.results[0]) {
          const result = data.results[0];
          return {
            address: result.formatted,
            city: result.components.city || 'Desconhecida',
            state: result.components.state || 'Desconhecido',
            country: result.components.country || 'Desconhecido'
          };
        } else {
          return { address: 'Endereço não encontrado' };
        }
      } catch (error) {
        console.error('Erro ao obter o endereço:', error);
        return { address: 'Erro ao obter o endereço' };
      }
    }

    // Função para rastrear a localização do dispositivo
    function trackLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(async (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;

          // Obtém o nível de bateria com a API do navegador
          const battery = await navigator.getBattery();
          const batteryLevel = Math.round(battery.level * 100); // Obtém o nível de bateria em %
          const deviceName = navigator.userAgent; // Nome do dispositivo (userAgent)

          // Atualiza a localização e informações do dispositivo no Firebase
          updateLocation(latitude, longitude, batteryLevel, deviceName);

          // Exibe a localização no mapa
          marker.setLatLng([latitude, longitude]);
          map.setView([latitude, longitude], 15);

          // Obtém o endereço e informações adicionais
          const { address, city, state, country } = await getAddressFromCoordinates(latitude, longitude);

          // Atualiza as informações na interface
          updateDeviceInfo(batteryLevel, deviceName, address, city, state, country);

          // Notifica quando o dispositivo se mover para um novo local
          if (lastLatitude !== latitude || lastLongitude !== longitude) {
            lastLatitude = latitude;
            lastLongitude = longitude;
            notificationDiv.innerHTML = `Nova localização detectada! Endereço: ${address}`;
          }
        }, (error) => {
          console.error('Erro ao obter a geolocalização', error);
        });
      } else {
        alert("Geolocalização não suportada pelo seu navegador.");
      }
    }

    // Função para exibir as informações do dispositivo
    function updateDeviceInfo(batteryLevel, deviceName, address, city, state, country) {
      deviceInfoDiv.innerHTML = `
        <div class="info-item"><span>Nome do Dispositivo:</span> ${deviceName}</div>
        <div class="info-item"><span>Nível de Bateria:</span> ${batteryLevel}%</div>
        <div class="info-item"><span>Endereço:</span> ${address}</div>
        <div class="info-item"><span>Cidade:</span> ${city}</div>
        <div class="info-item"><span>Estado:</span> ${state}</div>
        <div class="info-item"><span>País:</span> ${country}</div>
      `;
    }

    // Função para obter a localização do dispositivo em tempo real do Firebase
    function getLocationFromFirebase() {
      const locationRef = ref(db, 'locations/device');
      onValue(locationRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const { latitude, longitude, batteryLevel, deviceName } = data;
          if (latitude && longitude) {
            marker.setLatLng([latitude, longitude]);
            map.setView([latitude, longitude], 15);
            updateDeviceInfo(batteryLevel, deviceName, 'A buscar endereço...', 'Cidade', 'Estado', 'País');
          }
        }
      });
    }

    // Inicializa o sistema ao carregar a página
    window.onload = () => {
      deviceInfoDiv = document.getElementById('device-info');
      notificationDiv = document.getElementById('notification');
      initMap();
      trackLocation();
      getLocationFromFirebase();
    };
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
  <div id="map"></div>
  <div class="info-container" id="device-info">
    <div class="info-item"><span>Nome do Dispositivo:</span> Carregando...</div>
    <div class="info-item"><span>Nível de Bateria:</span> Carregando...</div>
    <div class="info-item"><span>Endereço:</span> Carregando...</div>
    <div class="info-item"><span>Cidade:</span> Carregando...</div>
    <div class="info-item"><span>Estado:</span> Carregando...</div>
    <div class="info-item"><span>País:</span> Carregando...</div>
  </div>
  <div class="notification" id="notification"></div>
</body>
</html>
