<html lang="pt-BR">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>KelvinChat</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <link href="https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@400&display=swap" rel="stylesheet">

  <style>

    body {

      font-family: 'Helvetica Neue', Arial, sans-serif;

    }

    #blocked-modal {

      display: none;

      position: fixed;

      top: 0;

      left: 0;

      width: 100%;

      height: 100%;

      background-color: rgba(0, 0, 0, 0.5);

      z-index: 1000;

      justify-content: center;

      align-items: center;

    }

    #blocked-modal .modal-content {

      background-color: white;

      padding: 20px;

      border-radius: 8px;

      text-align: center;

      width: 80%;

      max-width: 400px;

    }

  </style>

</head>

<body class="bg-gray-100 flex justify-center items-center h-screen">

  <div id="name-container" class="flex flex-col justify-center items-center bg-blue-500 text-white p-6 rounded-lg w-full max-w-md">

    <h1 class="text-2xl mb-4">Bem-vindo ao KelvinChat</h1>

    <input type="text" id="name-input" placeholder="Digite seu nome" class="p-2 text-gray-800 rounded mb-4 w-full max-w-xs">

    <button id="enter-chat" class="p-2 bg-blue-700 text-white rounded w-full max-w-xs">Entrar</button>

  </div>



  <div id="chat-container" class="hidden flex-col bg-white w-full max-w-lg h-4/5 rounded-lg shadow-lg">

    <div id="header" class="bg-blue-500 text-white p-4 text-center rounded-t-lg">KelvinChat</div>

    <div id="messages" class="flex-1 overflow-y-auto p-4 bg-gray-100"></div>

    <div id="input-container" class="flex items-center p-4 bg-gray-200 rounded-b-lg">

      <input type="file" id="file-input" accept="image/*" class="hidden">

      <button id="upload-button" class="p-2 bg-blue-500 text-white rounded mr-2"><i class="fas fa-camera"></i></button>

      <input type="text" id="message-input" placeholder="Digite sua mensagem" class="flex-1 p-2 border border-gray-300 rounded">

      <button id="send-button" class="p-2 bg-blue-500 text-white rounded ml-2">Enviar</button>

    </div>

  </div>



  <div id="blocked-modal" class="flex">

    <div class="modal-content">

      <h2 class="text-xl mb-4">Você foi bloqueado!</h2>

      <p class="mb-4">Motivo: Você foi bloqueado por infringir as regras do aplicativo.</p>

      <button id="close-blocked-modal" class="p-2 bg-red-500 text-white rounded">Fechar</button>

    </div>

  </div>



  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";

    import { getDatabase, ref, push, onValue, get, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";



    const firebaseConfig = {

      apiKey: "AIzaSyCPCljNgir3YlR1UV6h3Qyik84AYOp0u4A",

      authDomain: "crmpro-6b032.firebaseapp.com",

      databaseURL: "https://crmpro-6b032-default-rtdb.firebaseio.com",

      projectId: "crmpro-6b032",

      storageBucket: "crmpro-6b032.appspot.com",

      messagingSenderId: "491350225551",

      appId: "1:491350225551:web:0dd6f83a2d49752ca9b6fa",

    };



    const app = initializeApp(firebaseConfig);

    const database = getDatabase(app);

    const versionRef = ref(database, 'Version');

    const usersRef = ref(database, 'Users');

    const chatRef = ref(database, 'chat');



    const nameContainer = document.getElementById("name-container");

    const chatContainer = document.getElementById("chat-container");

    const nameInput = document.getElementById("name-input");

    const enterChatButton = document.getElementById("enter-chat");

    const messagesDiv = document.getElementById("messages");

    const messageInput = document.getElementById("message-input");

    const sendButton = document.getElementById("send-button");

    const fileInput = document.getElementById("file-input");

    const uploadButton = document.getElementById("upload-button");

    const blockedModal = document.getElementById("blocked-modal");

    const closeBlockedModalButton = document.getElementById("close-blocked-modal");



    let username = localStorage.getItem('username') || '';

    let version = localStorage.getItem('version') || '1.0';

    let userId = localStorage.getItem('userId') || null;

    let userBlocked = false;



    // Verificando se a versão do app foi alterada

    get(versionRef).then((snapshot) => {

      if (snapshot.exists()) {

        const versionData = snapshot.val();

        const newVersion = versionData.number || '1.0';

        const description = versionData.descricao || 'Nenhuma descrição';



        if (newVersion !== version) {

          localStorage.removeItem('username');

          localStorage.removeItem('userId');

          localStorage.setItem('version', newVersion);

          alert(`O aplicativo foi atualizado para a versão ${newVersion}. Descrição: ${description}`);

        }

      }

    });



    // Criar a pasta "Version" no Realtime Database caso não exista

    function createVersionNode() {

      get(versionRef).then((snapshot) => {

        if (!snapshot.exists()) {

          set(versionRef, {

            number: '1.0',

            descricao: 'Primeira versão do aplicativo.'

          });

        }

      });

    }



    // Criar a pasta "Users" no Realtime Database caso não exista

    function createUsersNode() {

      get(usersRef).then((snapshot) => {

        if (!snapshot.exists()) {

          set(usersRef, {});

        }

      });

    }



    // Criar a pasta "chat" no Realtime Database caso não exista

    function createChatNode() {

      get(chatRef).then((snapshot) => {

        if (!snapshot.exists()) {

          set(chatRef, {});

        }

      });

    }



    // Verificar e criar a pasta "Users" e o usuário caso necessário

    function createUserNode() {

      if (username && !userId) {

        const newUserRef = push(usersRef);

        userId = newUserRef.key; // Gerar um ID único para o usuário

        set(newUserRef, {

          name: username,

          blocked: false,

          rename: false

        });

        localStorage.setItem('userId', userId);

      }

    }



    // Verificar se o usuário está bloqueado

    function checkUserBlocked() {

      get(ref(database, 'Users/' + userId)).then((snapshot) => {

        if (snapshot.exists()) {

          const userData = snapshot.val();

          userBlocked = userData.blocked || false;

          if (userBlocked) {

            blockedModal.style.display = 'flex';

          }

        }

      });

    }



    // Exibir o chat

    function showChat() {

      nameContainer.style.display = "none";

      chatContainer.style.display = "flex";

    }



    enterChatButton.addEventListener("click", () => {

      username = nameInput.value.trim();

      if (username) {

        localStorage.setItem('username', username);

        createUserNode();

        showChat();

        checkUserBlocked();

      } else {

        alert("Por favor, insira seu nome!");

      }

    });



    sendButton.addEventListener("click", () => {

      if (userBlocked) {

        alert("Você está bloqueado e não pode enviar mensagens.");

        return;

      }

      const text = messageInput.value.trim();

      if (text && userId) {

        push(chatRef, { sender: username, text, userId });

        messageInput.value = "";

      }

    });



    uploadButton.addEventListener("click", () => {

      fileInput.click();

    });



    fileInput.addEventListener("change", async (e) => {

      if (userBlocked) {

        alert("Você está bloqueado e não pode enviar imagens.");

        return;

      }

      const file = e.target.files[0];

      if (file) {

        const reader = new FileReader();

        reader.onload = () => {

          const fileUrl = reader.result;

          push(chatRef, { sender: username, image: fileUrl, userId });

        };

        reader.readAsDataURL(file);

      }

    });



    // Carregar mensagens

    onValue(chatRef, (snapshot) => {

      messagesDiv.innerHTML = "";

      snapshot.forEach((childSnapshot) => {

        const message = childSnapshot.val();

        const messageDiv = document.createElement("div");

        messageDiv.classList.add("mb-2");

        if (message.text) {

          messageDiv.textContent = `${message.sender}: ${message.text}`;

        } else if (message.image) {

          const img = document.createElement("img");

          img.src = message.image;

          img.classList.add("w-40");

          messageDiv.appendChild(img);

        }

        messagesDiv.appendChild(messageDiv);

      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;

    });



    closeBlockedModalButton.addEventListener("click", () => {

      blockedModal.style.display = "none";

    });



    // Criar as pastas "Version", "Users" e "chat" caso não existam

    createVersionNode();

    createUsersNode();

    createChatNode();

  </script>

</body>

</html>

